<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Phân Loại Báo Chí</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/styles/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <ul class="circles"><li></li><li></li><li></li><li></li><li></li></ul>
    <div class="card" id="mainCard">
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('main')"><i class="fas fa-home"></i> Nhập Liệu</button>
            <button class="tab-btn" onclick="switchTab('viz')"><i class="fas fa-chart-pie"></i> Trực Quan Hóa</button>
        </div>

        <div id="tab-main" class="tab-content active">
            <div class="header-title"><i class="fas fa-newspaper"></i><h1>Phân Loại Tin Tức</h1></div>
            <form id="newsForm">
                <div class="input-group">
                    <label>Tiêu Đề Bài Viết</label>
                    <input type="text" id="title" placeholder="Ví dụ: Đội tuyển Việt Nam vô địch..." required autocomplete="off">
                </div>
                <div class="input-group">
                    <label>Nội Dung Chi Tiết</label>
                    <textarea id="content" placeholder="Paste nội dung bài báo vào đây..." required></textarea>
                </div>
                <div class="btn-group">
                    <button type="button" id="btnReset" onclick="resetApp()"><i class="fas fa-redo"></i> Làm Mới</button>
                    <button type="submit" id="btnPredict">
                        <span class="spinner" id="loadingSpinner"></span><span id="btnText">Phân Loại Ngay</span>
                    </button>
                </div>
            </form>
            <div id="result-area">
                <div class="result-box">
                    <div class="result-label">AI Dự đoán chủ đề:</div>
                    <div class="result-value" id="resultLabel">...</div>
                    <div class="confidence" id="confidenceLabel">...</div>
                    <div class="tag-container" id="tagContainer"></div>
                </div>
            </div>
        </div>

        <div id="tab-viz" class="tab-content">
            <div id="viz-content" style="display: none;">
                <div class="stats-row">
                    <div class="stat-card"><span class="stat-val" id="stat-words">0</span><span class="stat-lbl">Số từ</span></div>
                    <div class="stat-card"><span class="stat-val" id="stat-sents">0</span><span class="stat-lbl">Số câu</span></div>
                    <div class="stat-card"><span class="stat-val" id="stat-len">0</span><span class="stat-lbl">TB từ/câu</span></div>
                </div>
                <div class="dashboard-grid">
                    <div class="viz-card">
                        <div class="viz-title">XÁC SUẤT CHỦ ĐỀ</div>
                        <div class="chart-box"><canvas id="probChart"></canvas></div>
                    </div>
                    <div class="viz-card">
                        <div class="viz-title">TẦN SUẤT TỪ KHÓA</div>
                        <div class="chart-box"><canvas id="freqChart"></canvas></div>
                    </div>
                </div>
                <div class="dashboard-grid">
                    <div class="viz-card" style="grid-column: span 2;">
                        <div class="viz-title">ĐỘ TƯƠNG QUAN TỪ KHÓA</div>
                        <p style="font-size: 12px; color:#777; margin-bottom:10px;">Biểu đồ thể hiện mức độ xuất hiện cùng nhau của Top 5 từ khóa trong các câu văn.</p>
                        <div id="heatmapContainer"></div>
                    </div>
                </div>
                <div class="viz-card">
                    <div class="viz-title">PHÂN TÍCH VĂN BẢN</div>
                    <div class="highlight-box" id="highlightContent"></div>
                </div>
            </div>
            <div id="viz-empty" class="empty-state">
                <i class="fas fa-robot" style="font-size: 50px; margin-bottom: 20px; display:block; color:#ddd;"></i>
                Vui lòng phân loại ở tab "Nhập Liệu" trước để xem Dashboard.
            </div>
        </div>
    </div>

    <script>
        let probChart = null;
        let freqChart = null; 

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            const card = document.getElementById('mainCard');
            if (tabName === 'main') {
                document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
                document.getElementById('tab-main').classList.add('active');
                card.classList.remove('wide-mode'); 
            } else {
                document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
                document.getElementById('tab-viz').classList.add('active');
                card.classList.add('wide-mode'); 
            }
        }

        function resetApp() {
            document.getElementById('title').value = '';
            document.getElementById('content').value = '';
            document.getElementById('result-area').style.display = 'none';
            document.getElementById('viz-content').style.display = 'none';
            document.getElementById('viz-empty').style.display = 'block';
            if (probChart) probChart.destroy();
            if (freqChart) freqChart.destroy();
            probChart = null; freqChart = null;
            switchTab('main');
        }

        function renderHeatmap(labels, matrix) {
            const container = document.getElementById('heatmapContainer');
            if (!labels || labels.length === 0 || !matrix) {
                container.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">Không đủ dữ liệu.</p>';
                return;
            }
            const colCount = labels.length;
            let html = `<div class="heatmap-grid" style="grid-template-columns: 80px repeat(${colCount}, 1fr);">`;
            html += '<div class="hm-header"></div>'; 
            labels.forEach(l => html += `<div class="hm-header" style="font-size:10px;">${l}</div>`);

            let maxVal = 0;
            matrix.forEach(row => row.forEach(val => { if(val > maxVal) maxVal = val; }));
            if (maxVal === 0) maxVal = 1;

            matrix.forEach((row, i) => {
                html += `<div class="hm-label" style="font-size:10px;">${labels[i]}</div>`;
                row.forEach(val => {
                    let opacity = (val / maxVal).toFixed(2);
                    let bgColor = `rgba(0, 102, 255, ${Math.max(0.1, opacity)})`; 
                    let textColor = opacity > 0.6 ? '#fff' : '#333';
                    html += `<div class="hm-cell" style="background:${bgColor}; color:${textColor}" title="${val}">${val}</div>`;
                });
            });
            html += '</div>';
            container.innerHTML = html;
        }

        document.getElementById('newsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const btn = document.getElementById('btnPredict');
            const spinner = document.getElementById('loadingSpinner');
            const resultArea = document.getElementById('result-area');
            const tagContainer = document.getElementById('tagContainer');
            
            const titleInput = document.getElementById('title').value;
            const contentInput = document.getElementById('content').value;

            btn.disabled = true; spinner.style.display = 'inline-block'; 
            document.getElementById('btnText').innerText = 'Đang Xử Lý...';
            resultArea.style.display = 'none'; tagContainer.innerHTML = '';

            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: titleInput, content: contentInput })
                });
                const data = await response.json();

                if (data.status === 'success') {
                    document.getElementById('resultLabel').innerText = data.prediction;
                    document.getElementById('confidenceLabel').innerText = "Độ tin cậy: " + data.confidence;
                    if (data.display_keywords) {
                        data.display_keywords.forEach(word => {
                            tagContainer.innerHTML += `<span class="tag">${word}</span>`;
                        });
                    }
                    resultArea.style.display = 'block';

                    document.getElementById('viz-empty').style.display = 'none';
                    document.getElementById('viz-content').style.display = 'block';

                    const wordCount = contentInput.trim().split(/\s+/).length;
                    document.getElementById('stat-words').innerText = wordCount;
                    document.getElementById('stat-sents').innerText = data.sentence_count;
                    document.getElementById('stat-len').innerText = data.avg_sent_len;

                    let highlightedText = contentInput;
                    data.keywords.forEach(word => {
                        let searchWord = word.replace(/_/g, ' '); 
                        let regex = new RegExp(`(${searchWord})`, 'gi');
                        highlightedText = highlightedText.replace(regex, '<mark>$1</mark>');
                    });
                    document.getElementById('highlightContent').innerHTML = highlightedText;

                    if (data.heatmap_matrix && data.heatmap_labels) {
                        renderHeatmap(data.heatmap_labels, data.heatmap_matrix);
                    }

                    const ctxProb = document.getElementById('probChart').getContext('2d');
                    if (probChart) probChart.destroy();
                    probChart = new Chart(ctxProb, {
                        type: 'bar',
                        data: {
                            labels: data.prob_chart_data.map(d => d.label),
                            datasets: [{
                                label: 'Xác suất (%)',
                                data: data.prob_chart_data.map(d => d.prob),
                                backgroundColor: ['#0066ff', '#5c9dff', '#a3caff'],
                                borderRadius: 5
                            }]
                        },
                        options: {
                            indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { x: { display:false }, y: { grid: {display:false} } }
                        }
                    });

                    const ctxFreq = document.getElementById('freqChart').getContext('2d');
                    if (freqChart) freqChart.destroy();
                    freqChart = new Chart(ctxFreq, {
                        type: 'bar',
                        data: {
                            labels: data.freq_chart_data.map(d => d.word),
                            datasets: [{
                                label: 'Số lần xuất hiện',
                                data: data.freq_chart_data.map(d => d.count),
                                backgroundColor: '#10b981', 
                                borderRadius: 4,
                                barPercentage: 0.6
                            }]
                        },
                        options: {
                            indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { x: { display:false }, y: { grid: {display:false} } }
                        }
                    });

                } else {
                    alert('Lỗi: ' + data.message);
                }
            } catch (error) {
                console.error(error);
                alert('Mất kết nối Server!');
            } finally {
                btn.disabled = false; spinner.style.display = 'none'; 
                document.getElementById('btnText').innerText = 'Phân Loại Ngay';
            }
        });
    </script>
</body>
</html>